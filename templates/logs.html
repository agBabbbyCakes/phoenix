{% extends 'base.html' %}

{% block title %}Logs Viewer - Blockchain Bot Positions{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-950 text-gray-100 font-mono overflow-hidden"
     x-data="logsPageState()" 
     x-init="init()">
  
  <!-- LEFT SIDEBAR (Fixed) -->
  <aside class="w-64 border-r border-gray-800 bg-gray-900/95 backdrop-blur-xl flex flex-col fixed left-0 top-0 bottom-16 z-20 overflow-y-auto"
         style="box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);">
    
    <!-- Logo & Title -->
    <div class="p-4 border-b border-gray-800">
      <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
        ü¶ç Silverback
      </h1>
      <p class="text-xs text-gray-500 mt-1">Blockchain Bot Positions</p>
    </div>

    <!-- Navigation Section -->
    <div class="p-4">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Navigation</div>
      <nav class="space-y-1">
        <a href="/" class="sidebar-nav-link">Dashboard</a>
        <a href="/" class="sidebar-nav-link">Live Charts</a>
        <a href="/bots" class="sidebar-nav-link">Bots</a>
        <a href="/logs" class="sidebar-nav-link active">Logs</a>
        <a href="/report" class="sidebar-nav-link">Reports</a>
        <a href="/pointcloud" class="sidebar-nav-link">3D View</a>
        <a href="/tv" class="sidebar-nav-link">TV Mode</a>
      </nav>
    </div>

    <!-- Tools Section -->
    <div class="p-4 border-t border-gray-800">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Tools</div>
      <nav class="space-y-1">
        <button @click="showCommandPalette = !showCommandPalette" class="sidebar-nav-link w-full text-left">Command Palette</button>
        <button @click="exportData()" class="sidebar-nav-link w-full text-left">Export Data</button>
        <button @click="toggleTheme()" class="sidebar-nav-link w-full text-left">Theme</button>
      </nav>
    </div>

    <!-- Quick Stats -->
    <div class="p-4 border-t border-gray-800 space-y-3">
      <div class="text-xs uppercase text-gray-500 mb-2 tracking-wider">Log Stats</div>
      <div class="space-y-2">
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">Total Logs</div>
          <div class="text-sm font-semibold text-cyan-400" id="sidebarTotalLogs">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">Errors</div>
          <div class="text-sm font-semibold text-red-400" id="sidebarErrorCount">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">Warnings</div>
          <div class="text-sm font-semibold text-yellow-400" id="sidebarWarningCount">0</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- TOP BAR (Unified Global Navigation) -->
  <header class="fixed top-0 left-64 right-80 h-14 bg-gray-900/95 backdrop-blur-xl border-b border-gray-800 z-30 flex items-center justify-between px-6"
          style="box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);">
    
    <!-- Left: Brand & Navigation -->
    <div class="flex items-center gap-8">
      <div class="text-lg font-semibold text-cyan-400">Blockchain Bot Positions</div>
      <nav class="flex items-center gap-6">
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/bots" class="nav-link">Bots</a>
        <a href="/logs" class="nav-link active">Logs</a>
        <a href="/report" class="nav-link">Reports</a>
        <a href="/settings" class="nav-link">Settings</a>
      </nav>
    </div>

    <!-- Right: Live Info & Controls -->
    <div class="flex items-center gap-6 text-xs">
      <div class="flex items-center gap-2">
        <span class="text-gray-500">Latency:</span>
        <span class="text-cyan-400 font-semibold">-</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-gray-500">Success:</span>
        <span class="text-green-400 font-semibold">-</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-gray-500">Auto-refresh:</span>
        <span class="text-gray-400">5s</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-lg shadow-emerald-400/50"></div>
        <span class="text-gray-400">Connected</span>
      </div>
      <button @click="toggleTheme()" 
              class="p-1.5 rounded hover:bg-gray-800 transition-colors text-gray-400 hover:text-yellow-400"
              title="Toggle theme">
        <span x-show="theme === 'dark'">‚òÄÔ∏è</span>
        <span x-show="theme === 'light'">üåô</span>
      </button>
      <button @click="showCommandPalette = !showCommandPalette" 
              class="px-3 py-1.5 rounded border border-gray-700 hover:bg-gray-800 hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-colors text-xs"
              title="Command Palette (‚åòK)">
        ‚åòK
      </button>
    </div>
  </header>

  <!-- RIGHT SIDEBAR (Info) -->
  <aside class="w-80 border-l border-gray-800 bg-gray-900/95 backdrop-blur-xl flex flex-col fixed right-0 top-0 bottom-16 z-20 overflow-y-auto"
         style="box-shadow: -2px 0 20px rgba(0, 0, 0, 0.5);">
    
    <div class="p-4 border-b border-gray-800">
      <h2 class="text-sm font-semibold text-gray-300">Log Viewer Info</h2>
      <p class="text-xs text-gray-500">Import and analyze log entries</p>
    </div>

    <div class="p-4 space-y-4">
      <div class="text-xs text-gray-400">
        <div class="text-gray-500 mb-2">Quick Actions</div>
        <div class="space-y-2">
          <button onclick="document.getElementById('parseBtn').click()" 
                  class="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-cyan-600 text-gray-300 hover:text-white transition-colors text-xs">
            Parse Logs
          </button>
          <button onclick="document.getElementById('demoBtn').click()" 
                  class="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white transition-colors text-xs">
            Load Demo
          </button>
          <button onclick="document.getElementById('clearBtn').click()" 
                  class="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-red-600 text-gray-300 hover:text-white transition-colors text-xs">
            Clear All
          </button>
        </div>
      </div>
      <div class="text-xs text-gray-400">
        <div class="text-gray-500 mb-2">Export</div>
        <div class="space-y-2">
          <button onclick="document.getElementById('exportBtn').click()" 
                  class="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-300 hover:text-white transition-colors text-xs">
            Export JSON
          </button>
          <button onclick="document.getElementById('exportCsvBtn').click()" 
                  class="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-300 hover:text-white transition-colors text-xs">
            Export CSV
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-64 mr-80 mt-14 mb-16 overflow-auto bg-gray-950 p-6">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-100 mb-2">Logs Viewer</h1>
        <p class="text-gray-400">Paste or upload JSON log entries to view them in a structured format</p>
      </div>

      <!-- Input Section -->
      <div class="bg-gray-900/80 backdrop-blur-xl border border-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Import Logs</h2>
        <div class="flex gap-4 flex-col md:flex-row">
          <div class="flex-1">
            <label class="block text-xs text-gray-400 mb-2">Paste JSON Log Entries</label>
            <textarea
              id="logInput"
              class="w-full h-48 bg-gray-800 border border-gray-700 rounded p-3 font-mono text-sm text-gray-100 resize-none focus:outline-none focus:border-cyan-500"
              placeholder='Paste JSON log entries here, one per line or as a JSON array...&#10;&#10;Example:&#10;{"level":20,"timestamp":"2025-10-29T07:30:00Z","message":"price - Started"}&#10;{"level":30,"timestamp":"2025-10-29T07:30:00Z","message":"Request was rate-limited..."}'></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <button id="parseBtn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm font-semibold transition-colors">Parse & Display</button>
            <button id="demoBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold transition-colors">üé¨ Load Demo</button>
            <button id="clearBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-sm transition-colors">Clear</button>
            <label class="px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-sm transition-colors cursor-pointer text-center">
              üìÅ Upload File
              <input type="file" id="fileInput" accept=".json,.jsonl,.txt" class="hidden" />
            </label>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-gray-900/80 backdrop-blur-xl border border-gray-800 rounded-lg p-6 mb-6" id="filtersCard" style="display: none;">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-200">Filters</h2>
          <div class="flex gap-2">
            <button id="saveQueryBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-xs transition-colors">üíæ Save Query</button>
            <select id="savedQueries" class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-xs text-gray-100">
              <option value>Saved Queries...</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Search</label>
            <input type="text" id="searchInput" placeholder="Search in messages..." 
                   class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-gray-100 focus:outline-none focus:border-cyan-500" />
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Log Level</label>
            <select id="levelFilter" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-gray-100">
              <option value>All Levels</option>
              <option value="10">DEBUG (10)</option>
              <option value="20">INFO (20)</option>
              <option value="21">INFO+ (21)</option>
              <option value="30">WARNING (30)</option>
              <option value="40">ERROR (40)</option>
              <option value="50">CRITICAL (50)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Time Range Start</label>
            <input type="datetime-local" id="startTime" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-gray-100" />
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Time Range End</label>
            <input type="datetime-local" id="endTime" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-gray-100" />
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-5 gap-4 mb-6" id="statsBar" style="display: none;">
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">Total Logs</div>
          <div class="text-lg font-semibold text-cyan-400" id="totalLogs">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">INFO</div>
          <div class="text-lg font-semibold text-blue-400" id="infoCount">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">WARNING</div>
          <div class="text-lg font-semibold text-yellow-400" id="warningCount">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">ERROR</div>
          <div class="text-lg font-semibold text-red-400" id="errorCount">0</div>
        </div>
        <div class="quick-stat-card glass-stat-card">
          <div class="text-xs text-gray-400 mb-1">Transactions</div>
          <div class="text-lg font-semibold text-green-400" id="txCount">0</div>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="bg-gray-900/80 backdrop-blur-xl border border-gray-800 rounded-lg p-6" id="logsCard" style="display: none;">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-200">Log Entries</h2>
          <div class="flex gap-2">
            <button id="exportBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-green-600 border border-gray-700 hover:border-green-500 rounded text-xs text-gray-300 hover:text-white transition-colors">üì• Export JSON</button>
            <button id="exportCsvBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-green-600 border border-gray-700 hover:border-green-500 rounded text-xs text-gray-300 hover:text-white transition-colors">üì• Export CSV</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-800/50 border-b border-gray-800">
              <tr>
                <th class="px-4 py-3 text-left text-xs uppercase text-gray-500 tracking-wider">Time</th>
                <th class="px-4 py-3 text-left text-xs uppercase text-gray-500 tracking-wider">Level</th>
                <th class="px-4 py-3 text-left text-xs uppercase text-gray-500 tracking-wider">Message</th>
                <th class="px-4 py-3 text-left text-xs uppercase text-gray-500 tracking-wider">Details</th>
              </tr>
            </thead>
            <tbody id="logsTableBody" class="divide-y divide-gray-800">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="bg-gray-900/80 backdrop-blur-xl border border-gray-800 rounded-lg p-12 text-center">
        <div class="text-6xl mb-4">üìã</div>
        <h2 class="text-2xl font-bold text-gray-200 mb-2">No Logs Loaded</h2>
        <p class="text-gray-400">Paste or upload JSON log entries to get started</p>
      </div>
    </div>
  </main>

  <!-- BOTTOM BAR (Fixed) -->
  <footer class="fixed bottom-0 left-0 right-0 h-16 bg-gray-950/95 backdrop-blur-xl border-t border-gray-800/50 z-20"
          style="box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5), 0 -2px 10px rgba(6, 182, 212, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05);">
    <div class="max-w-full mx-auto px-6 h-full flex items-center justify-between">
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse shadow-lg shadow-cyan-400/50"></div>
          <span class="text-sm text-gray-400">Silverback v{{ version }}</span>
        </div>
        <div class="text-xs text-gray-500">
          Last updated: <span x-text="lastUpdated"></span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <a href="/" class="text-sm text-gray-400 hover:text-cyan-400 transition-colors hover:shadow-lg hover:shadow-cyan-400/20 px-3 py-1 rounded">
          Dashboard
        </a>
        <a href="/bots" class="text-sm text-gray-400 hover:text-purple-400 transition-colors hover:shadow-lg hover:shadow-purple-400/20 px-3 py-1 rounded">
          Bots
        </a>
        <a href="/logs" class="text-sm text-gray-400 hover:text-purple-400 transition-colors hover:shadow-lg hover:shadow-purple-400/20 px-3 py-1 rounded">
          Logs
        </a>
        <a href="/report" class="text-sm text-gray-400 hover:text-green-400 transition-colors hover:shadow-lg hover:shadow-green-400/20 px-3 py-1 rounded">
          Reports
        </a>
      </div>
    </div>
  </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
function logsPageState() {
  return {
    theme: localStorage.getItem('phoenix:theme') || 'dark',
    lastUpdated: new Date().toLocaleTimeString(),
    showCommandPalette: false,
    commandInput: '',
    
    init() {
      this.applyTheme();
      this.setupKeyboardShortcuts();
      setInterval(() => {
        this.lastUpdated = new Date().toLocaleTimeString();
      }, 5000);
    },
    
    toggleTheme() {
      this.theme = this.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('phoenix:theme', this.theme);
      this.applyTheme();
    },
    
    applyTheme() {
      document.documentElement.classList.toggle('light-theme', this.theme === 'light');
    },
    
    exportData() {
      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) exportBtn.click();
    },
    
    executeCommand() {
      const cmd = this.commandInput.trim().toLowerCase();
      switch (cmd) {
        case 'export':
          this.exportData();
          break;
        case 'theme':
          this.toggleTheme();
          break;
      }
      this.commandInput = '';
      this.showCommandPalette = false;
    },
    
    setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          this.showCommandPalette = !this.showCommandPalette;
        }
        if (e.key === 'Escape' && this.showCommandPalette) {
          this.showCommandPalette = false;
        }
      });
    }
  };
}

(() => {
  let allLogs = [];
  let filteredLogs = [];

  // Log level mapping
  const levelMap = {
    10: { name: 'DEBUG', class: 'badge-ghost', color: 'text-gray-400' },
    20: { name: 'INFO', class: 'badge-info', color: 'text-blue-400' },
    21: { name: 'INFO', class: 'badge-info', color: 'text-blue-400' },
    30: { name: 'WARN', class: 'badge-warning', color: 'text-yellow-400' },
    40: { name: 'ERROR', class: 'badge-error', color: 'text-red-400' },
    50: { name: 'CRITICAL', class: 'badge-error', color: 'text-red-600' },
  };

  function getLevelInfo(level) {
    return levelMap[level] || { name: `LEVEL-${level}`, class: 'badge-ghost', color: 'text-gray-500' };
  }

  // Extract transaction hash from message
  function extractTxHash(message) {
    const txPattern = /0x[a-fA-F0-9]{64}/g;
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    const matches = {
      hashes: message.match(txPattern) || [],
      urls: message.match(urlPattern) || []
    };
    return matches;
  }

  // Format timestamp
  function formatTimestamp(ts) {
    try {
      const date = new Date(ts);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    } catch (e) {
      return ts;
    }
  }

  // Parse JSON logs
  function parseLogs(input) {
    const logs = [];
    const trimmed = input.trim();
    
    try {
      const arr = JSON.parse(trimmed);
      if (Array.isArray(arr)) {
        return arr.filter(log => log && typeof log === 'object');
      }
    } catch (e) {
      // Not a JSON array, continue with line-by-line parsing
    }
    
    const lines = trimmed.split('\n').filter(line => line.trim());
    
    for (const line of lines) {
      try {
        const obj = JSON.parse(line.trim());
        if (obj && typeof obj === 'object') {
          logs.push(obj);
        }
      } catch (e) {
        console.warn('Failed to parse line:', line.substring(0, 100), e);
      }
    }
    
    return logs;
  }

  // Render logs table
  function renderLogs() {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';

    if (filteredLogs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">No logs match the current filters</td></tr>';
      return;
    }

    filteredLogs.forEach((log, idx) => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-800/50 transition-colors';
      const levelInfo = getLevelInfo(log.level);
      const timestamp = log.timestamp || log.time || '';
      const message = log.message || '';
      const txInfo = extractTxHash(message);
      
      let structuredData = {};
      const bracketMatch = message.match(/\[([^\]]+)\]/g);
      if (bracketMatch) {
        bracketMatch.forEach(m => {
          const content = m.slice(1, -1);
          const pairs = content.split(',').map(p => p.trim()).filter(p => p);
          pairs.forEach(pair => {
            const colonIdx = pair.indexOf(':');
            const eqIdx = pair.indexOf('=');
            if (eqIdx > 0) {
              let key, value;
              if (colonIdx > 0 && colonIdx < eqIdx) {
                key = pair.substring(0, eqIdx).trim();
                value = pair.substring(eqIdx + 1).trim();
              } else {
                key = pair.substring(0, eqIdx).trim();
                value = pair.substring(eqIdx + 1).trim();
              }
              if (key && value) {
                structuredData[key] = value;
              }
            }
          });
        });
      }

      let formattedMessage = message;
      txInfo.hashes.forEach(txHash => {
        const shortHash = `${txHash.slice(0, 10)}...${txHash.slice(-6)}`;
        const explorerUrl = `https://optimistic.etherscan.io/tx/${txHash}`;
        formattedMessage = formattedMessage.replace(
          txHash,
          `<a href="${explorerUrl}" target="_blank" class="text-cyan-400 hover:text-cyan-300 font-mono hover:underline">${shortHash}</a>`
        );
      });
      
      txInfo.urls.forEach(url => {
        if (!txInfo.hashes.some(hash => url.includes(hash))) {
          formattedMessage = formattedMessage.replace(
            url,
            `<a href="${url}" target="_blank" class="text-cyan-400 hover:text-cyan-300 hover:underline">${url}</a>`
          );
        }
      });
      
      const etherscanPattern = /(https?:\/\/[^\s/]+\.etherscan\.io\/[^\s]+)/g;
      const etherscanMatches = message.matchAll(etherscanPattern);
      for (const match of etherscanMatches) {
        const url = match[0];
        if (!formattedMessage.includes(`href="${url}"`)) {
          formattedMessage = formattedMessage.replace(
            url,
            `<a href="${url}" target="_blank" class="text-cyan-400 hover:text-cyan-300 font-mono hover:underline">${url}</a>`
          );
        }
      }

      const details = { ...log };
      delete details.message;
      delete details.timestamp;
      delete details.time;
      const detailsJson = JSON.stringify(details, null, 2);

      row.innerHTML = `
        <td class="px-4 py-3 font-mono text-xs text-gray-400">${formatTimestamp(timestamp)}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 rounded text-xs ${levelInfo.class}">${levelInfo.name}</span>
        </td>
        <td class="px-4 py-3">
          <div class="max-w-2xl">
            <div class="whitespace-pre-wrap break-words text-gray-300">${formattedMessage}</div>
            ${Object.keys(structuredData).length > 0 ? `
              <div class="mt-2 flex flex-wrap gap-1">
                ${Object.entries(structuredData).map(([k, v]) => 
                  `<span class="px-2 py-0.5 rounded text-xs bg-gray-800 border border-gray-700 text-gray-400">${k}=${v}</span>`
                ).join('')}
              </div>
            ` : ''}
          </div>
        </td>
        <td class="px-4 py-3">
          <div class="dropdown dropdown-left">
            <label tabindex="0" class="px-2 py-1 rounded text-xs bg-gray-800 hover:bg-gray-700 border border-gray-700 cursor-pointer text-gray-300">Details</label>
            <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-gray-900 border border-gray-700 rounded-lg w-96 max-h-96 overflow-auto">
              <li class="text-xs">
                <pre class="whitespace-pre-wrap font-mono text-xs text-gray-300">${detailsJson}</pre>
              </li>
            </ul>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
    });

    updateStats();
  }

  // Update statistics
  function updateStats() {
    const stats = {
      total: allLogs.length,
      info: allLogs.filter(l => l.level === 20 || l.level === 21).length,
      warning: allLogs.filter(l => l.level === 30).length,
      error: allLogs.filter(l => l.level >= 40).length,
      tx: allLogs.filter(l => {
        const msg = (l.message || '').toLowerCase();
        return msg.includes('tx/') || /0x[a-fA-F0-9]{64}/.test(msg);
      }).length
    };

    document.getElementById('totalLogs').textContent = stats.total;
    document.getElementById('infoCount').textContent = stats.info;
    document.getElementById('warningCount').textContent = stats.warning;
    document.getElementById('errorCount').textContent = stats.error;
    document.getElementById('txCount').textContent = stats.tx;
    
    // Update sidebar stats
    const sidebarTotal = document.getElementById('sidebarTotalLogs');
    const sidebarError = document.getElementById('sidebarErrorCount');
    const sidebarWarning = document.getElementById('sidebarWarningCount');
    if (sidebarTotal) sidebarTotal.textContent = stats.total;
    if (sidebarError) sidebarError.textContent = stats.error;
    if (sidebarWarning) sidebarWarning.textContent = stats.warning;
  }

  // Apply filters
  function applyFilters() {
    filteredLogs = [...allLogs];

    const search = document.getElementById('searchInput').value.toLowerCase();
    if (search) {
      filteredLogs = filteredLogs.filter(log => 
        (log.message || '').toLowerCase().includes(search) ||
        JSON.stringify(log).toLowerCase().includes(search)
      );
    }

    const level = document.getElementById('levelFilter').value;
    if (level) {
      filteredLogs = filteredLogs.filter(log => log.level === parseInt(level));
    }

    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    if (startTime || endTime) {
      filteredLogs = filteredLogs.filter(log => {
        const logTime = log.timestamp || log.time;
        if (!logTime) return true;
        const logDate = new Date(logTime);
        if (startTime && logDate < new Date(startTime)) return false;
        if (endTime && logDate > new Date(endTime)) return false;
        return true;
      });
    }

    renderLogs();
  }

  // Load demo data
  async function loadDemoLogs() {
    try {
      const response = await fetch('/static/data/sample_logs.json');
      const demoLogs = await response.json();
      const jsonString = demoLogs.map(log => JSON.stringify(log)).join('\n');
      document.getElementById('logInput').value = jsonString;
      document.getElementById('parseBtn').click();
    } catch (e) {
      console.error('Failed to load demo logs:', e);
      alert('Failed to load demo data. Make sure sample_logs.json exists in /static/data/');
    }
  }

  // Event listeners
  document.getElementById('demoBtn').addEventListener('click', loadDemoLogs);
  
  document.getElementById('parseBtn').addEventListener('click', () => {
    const input = document.getElementById('logInput').value;
    if (!input.trim()) {
      alert('Please paste or upload log entries');
      return;
    }

    try {
      allLogs = parseLogs(input);
      allLogs.sort((a, b) => {
        const tsA = new Date(a.timestamp || a.time || 0);
        const tsB = new Date(b.timestamp || b.time || 0);
        return tsB - tsA;
      });

      filteredLogs = [...allLogs];
      
      document.getElementById('filtersCard').style.display = 'block';
      document.getElementById('statsBar').style.display = 'grid';
      document.getElementById('logsCard').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';

      renderLogs();
    } catch (e) {
      alert('Error parsing logs: ' + e.message);
      console.error(e);
    }
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    document.getElementById('logInput').value = '';
    allLogs = [];
    filteredLogs = [];
    document.getElementById('filtersCard').style.display = 'none';
    document.getElementById('statsBar').style.display = 'none';
    document.getElementById('logsCard').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('logsTableBody').innerHTML = '';
    updateStats();
  });

  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      document.getElementById('logInput').value = event.target.result;
      document.getElementById('parseBtn').click();
    };
    reader.readAsText(file);
  });

  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('levelFilter').addEventListener('change', applyFilters);
  document.getElementById('startTime').addEventListener('change', applyFilters);
  document.getElementById('endTime').addEventListener('change', applyFilters);

  // Saved queries functionality
  function loadSavedQueries() {
    const saved = localStorage.getItem('phoenix:savedQueries');
    const queries = saved ? JSON.parse(saved) : [];
    const select = document.getElementById('savedQueries');
    select.innerHTML = '<option value="">Saved Queries...</option>';
    queries.forEach((q, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = q.name;
      select.appendChild(option);
    });
  }

  function saveCurrentQuery() {
    const name = prompt('Name for this query:');
    if (!name) return;
    
    const query = {
      name,
      search: document.getElementById('searchInput').value,
      level: document.getElementById('levelFilter').value,
      startTime: document.getElementById('startTime').value,
      endTime: document.getElementById('endTime').value,
      timestamp: new Date().toISOString()
    };

    const saved = localStorage.getItem('phoenix:savedQueries');
    const queries = saved ? JSON.parse(saved) : [];
    queries.push(query);
    localStorage.setItem('phoenix:savedQueries', JSON.stringify(queries));
    loadSavedQueries();
  }

  function loadQuery(idx) {
    const saved = localStorage.getItem('phoenix:savedQueries');
    const queries = saved ? JSON.parse(saved) : [];
    if (!queries[idx]) return;
    
    const q = queries[idx];
    document.getElementById('searchInput').value = q.search || '';
    document.getElementById('levelFilter').value = q.level || '';
    document.getElementById('startTime').value = q.startTime || '';
    document.getElementById('endTime').value = q.endTime || '';
    applyFilters();
  }

  document.getElementById('saveQueryBtn').addEventListener('click', saveCurrentQuery);
  document.getElementById('savedQueries').addEventListener('change', (e) => {
    if (e.target.value) loadQuery(parseInt(e.target.value));
  });
  loadSavedQueries();

  // Export functionality
  document.getElementById('exportBtn').addEventListener('click', () => {
    const dataStr = JSON.stringify(filteredLogs, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logs_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('exportCsvBtn').addEventListener('click', () => {
    const headers = ['Timestamp', 'Level', 'Message', 'Full JSON'];
    const rows = filteredLogs.map(log => [
      log.timestamp || log.time || '',
      log.level || '',
      (log.message || '').replace(/"/g, '""'),
      JSON.stringify(log).replace(/"/g, '""')
    ]);
    
    const csv = [
      headers.join(','),
      ...rows.map(r => r.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });
})();
</script>
{% endblock %}
