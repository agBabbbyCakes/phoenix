{% extends 'base.html' %}

{% block title %}Silverback ‚Äî Logic Builder{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/bot-explorer.css">
<div class="flex h-screen bg-gray-950 text-gray-100 font-mono overflow-hidden"
     x-data="logicBuilderState()" 
     x-init="init()">
  
  <!-- LEFT SIDEBAR (Fixed) -->
  <aside class="w-64 border-r border-gray-800/50 bg-gray-900/40 backdrop-blur-xl flex flex-col fixed left-0 top-11 bottom-16 z-20 overflow-y-auto"
         style="scrollbar-width: thin; scrollbar-color: rgba(6, 182, 212, 0.3) transparent;">
    
    <!-- Logo & Title -->
    <div class="p-4 border-b border-gray-800/50">
      <div class="flex items-center gap-3 mb-2">
        <img src="/static/imgs/silverback-grey.png" 
             alt="Silverback Logo" 
             class="h-8 w-8 object-contain"
             style="filter: brightness(0.9);">
        <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
          Silverback
        </h1>
      </div>
      <p class="text-xs text-gray-500 mt-1">Logic Builder</p>
    </div>

    <!-- Navigation Section -->
    <div class="p-4">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Navigation</div>
      <nav class="space-y-1">
        <a href="/" class="sidebar-nav-link">Dashboard</a>
        <a href="/explorer" class="sidebar-nav-link">Bot Explorer</a>
        <a href="/bots" class="sidebar-nav-link">Bots</a>
        <a href="/logs" class="sidebar-nav-link">Logs</a>
        <a href="/report" class="sidebar-nav-link">Reports</a>
        <a href="/logic-builder" class="sidebar-nav-link active">Logic Builder</a>
      </nav>
    </div>

    <!-- Investment Strategies Palette -->
    <div class="p-4 border-t border-gray-800/50">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Investment Strategies</div>
      <div class="space-y-2">
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="arbitrage">
          <div class="text-xs font-semibold text-cyan-400">üí± Arbitrage</div>
          <div class="text-[10px] text-gray-500">Cross-DEX price diff</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="liquidity">
          <div class="text-xs font-semibold text-emerald-400">üíß Liquidity</div>
          <div class="text-[10px] text-gray-500">LP provision</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="yield">
          <div class="text-xs font-semibold text-yellow-400">üåæ Yield Farm</div>
          <div class="text-[10px] text-gray-500">Staking rewards</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="mev">
          <div class="text-xs font-semibold text-purple-400">‚ö° MEV</div>
          <div class="text-[10px] text-gray-500">Max extract value</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="lending">
          <div class="text-xs font-semibold text-blue-400">üè¶ Lending</div>
          <div class="text-[10px] text-gray-500">Lend/borrow</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="trigger">
          <div class="text-xs font-semibold text-orange-400">‚ö° Trigger</div>
          <div class="text-[10px] text-gray-500">Price/event condition</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="condition">
          <div class="text-xs font-semibold text-pink-400">üîÄ Condition</div>
          <div class="text-[10px] text-gray-500">If/else logic</div>
        </div>
        <div class="component-drag bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded-lg p-2 cursor-move hover:border-cyan-500/50 transition-all"
             draggable="true"
             data-type="risk">
          <div class="text-xs font-semibold text-red-400">üõ°Ô∏è Risk Check</div>
          <div class="text-[10px] text-gray-500">Slippage/limit</div>
        </div>
      </div>
    </div>
    
    <!-- Code Examples -->
    <div class="p-4 border-t border-gray-800/50">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Code Examples</div>
      <div class="space-y-2">
        <button @click="showCodeExample('arbitrage')"
                class="w-full text-left px-2 py-1.5 rounded text-xs bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-all">
          üí± Arbitrage Bot
        </button>
        <button @click="showCodeExample('liquidity')"
                class="w-full text-left px-2 py-1.5 rounded text-xs bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-all">
          üíß LP Strategy
        </button>
        <button @click="showCodeExample('yield')"
                class="w-full text-left px-2 py-1.5 rounded text-xs bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-all">
          üåæ Yield Farm
        </button>
        <button @click="showCodeExample('mev')"
                class="w-full text-left px-2 py-1.5 rounded text-xs bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-all">
          ‚ö° MEV Bot
        </button>
      </div>
    </div>

    <!-- Saved Workflows -->
    <div class="p-4 border-t border-gray-800/50">
      <div class="text-xs uppercase text-gray-500 mb-3 tracking-wider">Saved</div>
      <div class="space-y-1">
        <template x-for="workflow in savedWorkflows" :key="workflow.id">
          <button @click="loadWorkflow(workflow.id)"
                  class="w-full text-left px-2 py-1.5 rounded text-xs bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm hover:border-cyan-500/50 text-gray-400 hover:text-cyan-400 transition-all">
            <div class="font-semibold" x-text="workflow.name"></div>
            <div class="text-[10px] text-gray-500" x-text="workflow.updatedAt"></div>
          </button>
        </template>
      </div>
    </div>
  </aside>

  <!-- TOP BAR -->
  <header class="fixed top-0 left-0 right-0 h-14 bg-gray-900/40 backdrop-blur-xl border-b border-gray-800/50 z-30 flex items-center justify-between px-6">
    <div class="flex items-center gap-8 ml-64">
      <nav class="flex items-center gap-6">
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/explorer" class="nav-link">Bot Explorer</a>
        <a href="/logic-builder" class="nav-link active">Logic Builder</a>
        <a href="/bots" class="nav-link">Bots</a>
      </nav>
    </div>
    <div class="flex items-center gap-4 text-xs mr-96">
      <button @click="saveWorkflow()"
              class="px-3 py-1.5 rounded border border-cyan-500/50 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/20 transition-all backdrop-blur-sm">
        üíæ Save
      </button>
      <button @click="clearCanvas()"
              class="px-3 py-1.5 rounded border border-gray-700/50 bg-gray-800/30 text-gray-400 hover:text-red-400 transition-all backdrop-blur-sm">
        üóëÔ∏è Clear
      </button>
      <button @click="exportWorkflow()"
              class="px-3 py-1.5 rounded border border-gray-700/50 bg-gray-800/30 text-gray-400 hover:text-cyan-400 transition-all backdrop-blur-sm">
        üì§ Export
      </button>
    </div>
  </header>

  <!-- RIGHT SIDEBAR -->
  <aside class="w-96 border-l border-gray-800/50 bg-gray-900/40 backdrop-blur-xl flex flex-col fixed right-0 top-11 bottom-16 z-20 overflow-hidden">
    <!-- Tabs -->
    <div class="flex border-b border-gray-800/50">
      <button @click="activeTab = 'properties'" 
              :class="activeTab === 'properties' ? 'border-b-2 border-cyan-500 text-cyan-400' : 'text-gray-500'"
              class="flex-1 px-4 py-2 text-xs font-semibold hover:text-gray-300 transition-colors">
        Properties
      </button>
      <button @click="activeTab = 'code'" 
              :class="activeTab === 'code' ? 'border-b-2 border-cyan-500 text-cyan-400' : 'text-gray-500'"
              class="flex-1 px-4 py-2 text-xs font-semibold hover:text-gray-300 transition-colors">
        Code Preview
      </button>
    </div>
    
    <!-- Properties Tab -->
    <div class="flex-1 overflow-y-auto" x-show="activeTab === 'properties'">
      <div class="p-4" x-show="selectedNode">
        <template x-if="selectedNode">
          <div class="space-y-4">
            <div>
              <label class="block text-xs text-gray-400 mb-2">Strategy Type</label>
              <div class="text-sm font-semibold text-cyan-400" x-text="selectedNode.type"></div>
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-2">Label</label>
              <input type="text" x-model="selectedNode.label"
                     @input="updateCodePreview()"
                     class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
            </div>
            
            <!-- Arbitrage Strategy -->
            <template x-if="selectedNode.type === 'arbitrage'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Token Pair</label>
                  <input type="text" x-model="selectedNode.tokenPair" placeholder="ETH/USDC"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Min Profit %</label>
                  <input type="number" x-model="selectedNode.minProfit" placeholder="0.5"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">DEX A</label>
                  <select x-model="selectedNode.dexA"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="uniswap">Uniswap V3</option>
                    <option value="sushiswap">SushiSwap</option>
                    <option value="curve">Curve</option>
                    <option value="balancer">Balancer</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">DEX B</label>
                  <select x-model="selectedNode.dexB"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="uniswap">Uniswap V3</option>
                    <option value="sushiswap">SushiSwap</option>
                    <option value="curve">Curve</option>
                    <option value="balancer">Balancer</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Max Slippage %</label>
                  <input type="number" x-model="selectedNode.maxSlippage" placeholder="0.1"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Gas Limit</label>
                  <input type="number" x-model="selectedNode.gasLimit" placeholder="300000"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <!-- Liquidity Strategy -->
            <template x-if="selectedNode.type === 'liquidity'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Pool Address</label>
                  <input type="text" x-model="selectedNode.poolAddress" placeholder="0x..."
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Token A Amount</label>
                  <input type="number" x-model="selectedNode.tokenAAmount" placeholder="1.0"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Token B Amount</label>
                  <input type="number" x-model="selectedNode.tokenBAmount" placeholder="3000.0"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Fee Tier</label>
                  <select x-model="selectedNode.feeTier"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="500">0.05%</option>
                    <option value="3000">0.3%</option>
                    <option value="10000">1%</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Price Range (Lower)</label>
                  <input type="number" x-model="selectedNode.priceLower" placeholder="1800"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Price Range (Upper)</label>
                  <input type="number" x-model="selectedNode.priceUpper" placeholder="2200"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <!-- Yield Farming Strategy -->
            <template x-if="selectedNode.type === 'yield'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Protocol</label>
                  <select x-model="selectedNode.protocol"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="aave">Aave</option>
                    <option value="compound">Compound</option>
                    <option value="yearn">Yearn</option>
                    <option value="curve">Curve Gauge</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Token</label>
                  <input type="text" x-model="selectedNode.token" placeholder="USDC"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Amount</label>
                  <input type="number" x-model="selectedNode.amount" placeholder="10000"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Min APY %</label>
                  <input type="number" x-model="selectedNode.minAPY" placeholder="5.0"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <!-- MEV Strategy -->
            <template x-if="selectedNode.type === 'mev'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">MEV Type</label>
                  <select x-model="selectedNode.mevType"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="frontrun">Front-run</option>
                    <option value="backrun">Back-run</option>
                    <option value="sandwich">Sandwich</option>
                    <option value="arbitrage">MEV Arbitrage</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Min Profit (ETH)</label>
                  <input type="number" x-model="selectedNode.minProfitETH" placeholder="0.01"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Gas Price (Gwei)</label>
                  <input type="number" x-model="selectedNode.gasPrice" placeholder="50"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <!-- Trigger -->
            <template x-if="selectedNode.type === 'trigger'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Trigger Type</label>
                  <select x-model="selectedNode.triggerType"
                          @change="updateCodePreview()"
                          class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                    <option value="price">Price Threshold</option>
                    <option value="volume">Volume Spike</option>
                    <option value="liquidity">Liquidity Change</option>
                    <option value="gas">Gas Price</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Threshold</label>
                  <input type="number" x-model="selectedNode.threshold"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Token Address</label>
                  <input type="text" x-model="selectedNode.tokenAddress" placeholder="0x..."
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <!-- Risk Check -->
            <template x-if="selectedNode.type === 'risk'">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Max Slippage %</label>
                  <input type="number" x-model="selectedNode.maxSlippage" placeholder="0.5"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Max Gas Cost (ETH)</label>
                  <input type="number" x-model="selectedNode.maxGasCost" placeholder="0.05"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-2">Min Profit Margin %</label>
                  <input type="number" x-model="selectedNode.minProfitMargin" placeholder="1.0"
                         @input="updateCodePreview()"
                         class="w-full bg-gray-800/30 border border-gray-700/50 backdrop-blur-sm rounded px-3 py-2 text-sm text-gray-100">
                </div>
              </div>
            </template>
            
            <button @click="deleteNode(selectedNode.id)"
                    class="w-full px-3 py-2 rounded border border-red-500/50 bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-all backdrop-blur-sm text-xs mt-4">
              Delete Node
            </button>
          </div>
        </template>
        <div x-show="!selectedNode" class="text-xs text-gray-500 text-center py-8">
          Select a node to edit
        </div>
      </div>
    </div>
    
    <!-- Code Preview Tab -->
    <div class="flex-1 overflow-y-auto" x-show="activeTab === 'code'">
      <div class="p-4">
        <div class="mb-3 flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-300">Generated Code</h3>
          <button @click="copyCode()"
                  class="px-2 py-1 rounded border border-cyan-500/50 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/20 transition-all text-xs">
            Copy
          </button>
        </div>
        <pre class="bg-gray-950/80 border border-gray-800/50 rounded p-3 text-xs text-gray-300 overflow-x-auto" 
             x-text="generatedCode"></pre>
        <div x-show="selectedNode && selectedNode.type" class="mt-4">
          <div class="text-xs text-gray-500 mb-2">Example for: <span class="text-cyan-400" x-text="selectedNode.type"></span></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Canvas -->
  <main class="flex-1 ml-64 mr-96 mt-14 mb-16 overflow-auto bg-gray-950/50 p-6">
    <div class="max-w-full">
      <div class="mb-4 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-200">Visual Logic Builder</h1>
        <div class="text-xs text-gray-500">
          Drag components from sidebar ‚Ä¢ Connect nodes ‚Ä¢ Configure in properties
        </div>
      </div>
      
      <!-- Canvas Area -->
      <div id="logic-canvas" 
           class="min-h-[600px] bg-gray-900/20 border border-gray-800/50 backdrop-blur-sm rounded-lg relative overflow-hidden"
           @drop="handleDrop($event)"
           @dragover.prevent="handleDragOver($event)">
        
        <!-- Grid Background -->
        <div class="absolute inset-0 opacity-20"
             style="background-image: linear-gradient(rgba(6, 182, 212, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
        
        <!-- Nodes -->
        <template x-for="node in nodes" :key="node.id">
          <div class="absolute cursor-move"
               :style="`left: ${node.x}px; top: ${node.y}px;`"
               @mousedown="startDrag(node.id, $event)"
               @click="selectNode(node.id)">
            <div class="node-container bg-gray-800/40 border border-gray-700/50 backdrop-blur-xl rounded-lg p-3 min-w-[150px]"
                 :class="{
                   'border-cyan-500/50': selectedNode && selectedNode.id === node.id,
                   'border-cyan-500/50': node.type === 'arbitrage',
                   'border-emerald-500/50': node.type === 'liquidity' || node.type === 'yield',
                   'border-purple-500/50': node.type === 'mev',
                   'border-blue-500/50': node.type === 'lending',
                   'border-orange-500/50': node.type === 'trigger',
                   'border-pink-500/50': node.type === 'condition',
                   'border-red-500/50': node.type === 'risk'
                 }">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">
                  <template x-if="node.type === 'arbitrage'">üí±</template>
                  <template x-if="node.type === 'liquidity'">üíß</template>
                  <template x-if="node.type === 'yield'">üåæ</template>
                  <template x-if="node.type === 'mev'">‚ö°</template>
                  <template x-if="node.type === 'lending'">üè¶</template>
                  <template x-if="node.type === 'trigger'">‚ö°</template>
                  <template x-if="node.type === 'condition'">üîÄ</template>
                  <template x-if="node.type === 'risk'">üõ°Ô∏è</template>
                </span>
                <div class="text-xs font-semibold text-gray-200" x-text="node.label || node.type"></div>
              </div>
              <div class="text-[10px] text-gray-500" x-text="getNodeDescription(node)"></div>
            </div>
          </div>
        </template>
        
        <!-- Connections (SVG overlay) -->
        <svg class="absolute inset-0 pointer-events-none" style="z-index: 1;">
          <template x-for="connection in connections" :key="connection.id">
            <line :x1="getNodeX(connection.from)" 
                  :y1="getNodeY(connection.from)"
                  :x2="getNodeX(connection.to)"
                  :y2="getNodeY(connection.to)"
                  stroke="rgba(6, 182, 212, 0.5)"
                  stroke-width="2"
                  marker-end="url(#arrowhead)"/>
          </template>
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="rgba(6, 182, 212, 0.5)"/>
            </marker>
          </defs>
        </svg>
        
        <div x-show="nodes.length === 0" class="absolute inset-0 flex items-center justify-center">
          <div class="text-center text-gray-500">
            <div class="text-4xl mb-4">üé®</div>
            <div class="text-sm">Drag components from the sidebar to start building</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- BOTTOM BAR -->
  <footer class="fixed bottom-0 left-0 right-0 h-16 bg-gray-950/40 backdrop-blur-xl border-t border-gray-800/50 z-20">
    <div class="max-w-full mx-auto px-6 h-full flex items-center justify-between">
      <div class="flex items-center gap-6">
        <div class="text-xs text-gray-500">
          Nodes: <span class="text-cyan-400 font-semibold" x-text="nodes.length"></span>
        </div>
        <div class="text-xs text-gray-500">
          Connections: <span class="text-cyan-400 font-semibold" x-text="connections.length"></span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <button @click="testWorkflow()"
                class="px-3 py-1.5 rounded border border-emerald-500/50 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 transition-all backdrop-blur-sm text-xs">
          ‚ñ∂Ô∏è Test
        </button>
        <button @click="deployWorkflow()"
                class="px-3 py-1.5 rounded border border-cyan-500/50 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/20 transition-all backdrop-blur-sm text-xs">
          üöÄ Deploy
        </button>
      </div>
    </div>
  </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
function logicBuilderState() {
  return {
    nodes: [],
    connections: [],
    selectedNode: null,
    draggingNode: null,
    dragOffset: { x: 0, y: 0 },
    availableBots: [],
    savedWorkflows: JSON.parse(localStorage.getItem('phoenix:savedWorkflows') || '[]'),
    nodeIdCounter: 0,
    activeTab: 'properties',
    generatedCode: '// Select a node to see generated code\n// Or click "Code Examples" in the sidebar',
    
    init() {
      this.loadBots();
      this.loadSavedWorkflows();
      this.setupDragAndDrop();
    },
    
    async loadBots() {
      try {
        const response = await fetch('/api/bots/status');
        const data = await response.json();
        this.availableBots = (data.bots || []).map(b => b.bot_name || b.name);
      } catch (e) {
        console.error('Failed to load bots', e);
      }
    },
    
    loadSavedWorkflows() {
      this.savedWorkflows = JSON.parse(localStorage.getItem('phoenix:savedWorkflows') || '[]');
    },
    
    setupDragAndDrop() {
      document.querySelectorAll('.component-drag').forEach(el => {
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('type', el.dataset.type);
        });
      });
    },
    
    handleDragOver(e) {
      e.preventDefault();
    },
    
    handleDrop(e) {
      e.preventDefault();
      const type = e.dataTransfer.getData('type');
      if (type) {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        this.addNode(type, x, y);
      }
    },
    
    addNode(type, x, y) {
      const node = {
        id: `node_${this.nodeIdCounter++}`,
        type: type,
        label: type.charAt(0).toUpperCase() + type.slice(1),
        x: x,
        y: y,
        // Arbitrage defaults
        tokenPair: 'ETH/USDC',
        minProfit: 0.5,
        dexA: 'uniswap',
        dexB: 'sushiswap',
        maxSlippage: 0.1,
        gasLimit: 300000,
        // Liquidity defaults
        poolAddress: '',
        tokenAAmount: 1.0,
        tokenBAmount: 3000.0,
        feeTier: 3000,
        priceLower: 1800,
        priceUpper: 2200,
        // Yield defaults
        protocol: 'aave',
        token: 'USDC',
        amount: 10000,
        minAPY: 5.0,
        // MEV defaults
        mevType: 'frontrun',
        minProfitETH: 0.01,
        gasPrice: 50,
        // Trigger defaults
        triggerType: 'price',
        threshold: 2000,
        tokenAddress: '',
        // Risk defaults
        maxGasCost: 0.05,
        minProfitMargin: 1.0,
        // Legacy
        eventType: 'latency',
        actionType: 'restart',
        targetBot: '',
        condition: 'gt',
        value: 0
      };
      this.nodes.push(node);
      this.selectNode(node.id);
      this.updateCodePreview();
    },
    
    startDrag(nodeId, e) {
      const node = this.nodes.find(n => n.id === nodeId);
      if (node) {
        this.draggingNode = node;
        const rect = e.currentTarget.getBoundingClientRect();
        this.dragOffset = {
          x: e.clientX - rect.left - node.x,
          y: e.clientY - rect.top - node.y
        };
        document.addEventListener('mousemove', this.handleMouseMove.bind(this));
        document.addEventListener('mouseup', this.handleMouseUp.bind(this));
      }
    },
    
    handleMouseMove(e) {
      if (this.draggingNode) {
        const canvas = document.getElementById('logic-canvas');
        const rect = canvas.getBoundingClientRect();
        this.draggingNode.x = e.clientX - rect.left - this.dragOffset.x;
        this.draggingNode.y = e.clientY - rect.top - this.dragOffset.y;
      }
    },
    
    handleMouseUp() {
      this.draggingNode = null;
      document.removeEventListener('mousemove', this.handleMouseMove);
      document.removeEventListener('mouseup', this.handleMouseUp);
    },
    
    selectNode(nodeId) {
      this.selectedNode = this.nodes.find(n => n.id === nodeId);
    },
    
    deleteNode(nodeId) {
      this.nodes = this.nodes.filter(n => n.id !== nodeId);
      this.connections = this.connections.filter(c => c.from !== nodeId && c.to !== nodeId);
      if (this.selectedNode && this.selectedNode.id === nodeId) {
        this.selectedNode = null;
      }
    },
    
    getNodeDescription(node) {
      if (node.type === 'arbitrage') return `${node.tokenPair || 'Token'} | Min ${node.minProfit || 0.5}% profit`;
      if (node.type === 'liquidity') return `LP ${node.tokenAAmount || 0}/${node.tokenBAmount || 0}`;
      if (node.type === 'yield') return `${node.protocol || 'Protocol'} | ${node.token || 'Token'}`;
      if (node.type === 'mev') return `${node.mevType || 'MEV'} | Min ${node.minProfitETH || 0} ETH`;
      if (node.type === 'lending') return `Lend/borrow strategy`;
      if (node.type === 'trigger') return `${node.triggerType || 'Trigger'} > ${node.threshold || 0}`;
      if (node.type === 'condition') return `${node.condition || 'gt'} ${node.value || 0}`;
      if (node.type === 'risk') return `Max slippage: ${node.maxSlippage || 0}%`;
      return 'Configure in properties';
    },
    
    getNodeX(nodeId) {
      const node = this.nodes.find(n => n.id === nodeId);
      return node ? node.x + 75 : 0;
    },
    
    getNodeY(nodeId) {
      const node = this.nodes.find(n => n.id === nodeId);
      return node ? node.y + 40 : 0;
    },
    
    saveWorkflow() {
      const name = prompt('Workflow name:');
      if (!name) return;
      
      const workflow = {
        id: Date.now().toString(),
        name: name,
        nodes: this.nodes,
        connections: this.connections,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toLocaleDateString()
      };
      
      const existingIndex = this.savedWorkflows.findIndex(w => w.id === workflow.id);
      if (existingIndex > -1) {
        this.savedWorkflows[existingIndex] = workflow;
      } else {
        this.savedWorkflows.push(workflow);
      }
      
      localStorage.setItem('phoenix:savedWorkflows', JSON.stringify(this.savedWorkflows));
      alert('Workflow saved!');
    },
    
    loadWorkflow(workflowId) {
      const workflow = this.savedWorkflows.find(w => w.id === workflowId);
      if (workflow) {
        this.nodes = workflow.nodes || [];
        this.connections = workflow.connections || [];
        this.nodeIdCounter = Math.max(...this.nodes.map(n => parseInt(n.id.split('_')[1]) || 0), 0) + 1;
      }
    },
    
    clearCanvas() {
      if (confirm('Clear all nodes and connections?')) {
        this.nodes = [];
        this.connections = [];
        this.selectedNode = null;
      }
    },
    
    exportWorkflow() {
      const data = {
        nodes: this.nodes,
        connections: this.connections,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `workflow-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    },
    
    testWorkflow() {
      alert('Testing workflow... (This would validate the logic in production)');
    },
    
    deployWorkflow() {
      if (confirm('Deploy this workflow? It will start executing automatically.')) {
        alert('Workflow deployed! (This would activate the logic in production)');
      }
    },
    
    updateCodePreview() {
      if (!this.selectedNode) {
        this.generatedCode = '// Select a node to see generated code';
        return;
      }
      this.generatedCode = this.generateCodeForNode(this.selectedNode);
    },
    
    generateCodeForNode(node) {
      if (node.type === 'arbitrage') {
        return `# Arbitrage Bot Strategy
from web3 import Web3
from decimal import Decimal

class ArbitrageBot:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
        self.token_pair = "${node.tokenPair || 'ETH/USDC'}"
        self.min_profit_pct = ${node.minProfit || 0.5}
        self.dex_a = "${node.dexA || 'uniswap'}"
        self.dex_b = "${node.dexB || 'sushiswap'}"
        self.max_slippage = ${node.maxSlippage || 0.1}
        self.gas_limit = ${node.gasLimit || 300000}
    
    def check_arbitrage_opportunity(self):
        """Check for price difference between DEXes"""
        price_a = self.get_price(self.dex_a)
        price_b = self.get_price(self.dex_b)
        
        profit_pct = abs(price_a - price_b) / min(price_a, price_b) * 100
        
        if profit_pct >= self.min_profit_pct:
            return self.execute_arbitrage(price_a, price_b)
        return False
    
    def execute_arbitrage(self, price_a, price_b):
        """Execute arbitrage trade"""
        if price_a < price_b:
            # Buy on DEX A, sell on DEX B
            return self.trade(self.dex_a, 'buy') and self.trade(self.dex_b, 'sell')
        else:
            # Buy on DEX B, sell on DEX A
            return self.trade(self.dex_b, 'buy') and self.trade(self.dex_a, 'sell')`;
      }
      
      if (node.type === 'liquidity') {
        return `# Liquidity Provision Strategy
from web3 import Web3
from decimal import Decimal

class LiquidityProvider:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
        self.pool_address = "${node.poolAddress || '0x...'}"
        self.token_a_amount = ${node.tokenAAmount || 1.0}
        self.token_b_amount = ${node.tokenBAmount || 3000.0}
        self.fee_tier = ${node.feeTier || 3000}  # 0.3%
        self.price_lower = ${node.priceLower || 1800}
        self.price_upper = ${node.priceUpper || 2200}
    
    def add_liquidity(self):
        """Add liquidity to Uniswap V3 pool"""
        pool = self.w3.eth.contract(
            address=self.pool_address,
            abi=UNISWAP_V3_POOL_ABI
        )
        
        # Calculate tick range
        tick_lower = self.price_to_tick(self.price_lower)
        tick_upper = self.price_to_tick(self.price_upper)
        
        # Approve tokens
        self.approve_token(self.token_a_address, self.token_a_amount)
        self.approve_token(self.token_b_address, self.token_b_amount)
        
        # Add liquidity
        tx = pool.functions.mint(
            tick_lower,
            tick_upper,
            self.calculate_liquidity_amount(),
            self.w3.to_checksum_address(self.w3.eth.default_account)
        ).transact({'gas': 500000})
        
        return self.w3.eth.wait_for_transaction_receipt(tx)`;
      }
      
      if (node.type === 'yield') {
        return `# Yield Farming Strategy
from web3 import Web3
from decimal import Decimal

class YieldFarmer:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
        self.protocol = "${node.protocol || 'aave'}"
        self.token = "${node.token || 'USDC'}"
        self.amount = ${node.amount || 10000}
        self.min_apy = ${node.minAPY || 5.0}
    
    def find_best_yield(self):
        """Find best yield opportunity across protocols"""
        protocols = {
            'aave': self.get_aave_apy(),
            'compound': self.get_compound_apy(),
            'yearn': self.get_yearn_apy(),
            'curve': self.get_curve_apy()
        }
        
        best_protocol = max(protocols, key=protocols.get)
        best_apy = protocols[best_protocol]
        
        if best_apy >= self.min_apy:
            return self.deposit(best_protocol, self.amount)
        return False
    
    def deposit(self, protocol, amount):
        """Deposit tokens to yield protocol"""
        if protocol == 'aave':
            return self.deposit_to_aave(amount)
        elif protocol == 'compound':
            return self.deposit_to_compound(amount)
        # ... other protocols`;
      }
      
      if (node.type === 'mev') {
        return `# MEV Bot Strategy
from web3 import Web3
from eth_utils import to_hex

class MEVBot:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
        self.mev_type = "${node.mevType || 'frontrun'}"
        self.min_profit_eth = ${node.minProfitETH || 0.01}
        self.gas_price = ${node.gasPrice || 50}  # Gwei
    
    def monitor_mempool(self):
        """Monitor pending transactions in mempool"""
        pending_txs = self.w3.eth.get_pending_transactions()
        
        for tx in pending_txs:
            if self.is_profitable_opportunity(tx):
                if self.mev_type == 'frontrun':
                    return self.frontrun(tx)
                elif self.mev_type == 'backrun':
                    return self.backrun(tx)
                elif self.mev_type == 'sandwich':
                    return self.sandwich(tx)
    
    def frontrun(self, target_tx):
        """Front-run a profitable transaction"""
        # Calculate profit
        profit = self.estimate_profit(target_tx)
        
        if profit < self.min_profit_eth:
            return False
        
        # Build front-running transaction
        frontrun_tx = self.build_frontrun_tx(target_tx)
        
        # Submit with higher gas price
        frontrun_tx['gasPrice'] = self.w3.to_wei(self.gas_price, 'gwei')
        signed = self.w3.eth.account.sign_transaction(frontrun_tx, private_key)
        
        return self.w3.eth.send_raw_transaction(signed.rawTransaction)`;
      }
      
      if (node.type === 'trigger') {
        return `# Price Trigger Strategy
from web3 import Web3
from decimal import Decimal

class PriceTrigger:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
        self.trigger_type = "${node.triggerType || 'price'}"
        self.threshold = ${node.threshold || 2000}
        self.token_address = "${node.tokenAddress || '0x...'}"
    
    def check_trigger(self):
        """Check if trigger condition is met"""
        if self.trigger_type == 'price':
            current_price = self.get_token_price(self.token_address)
            return current_price >= self.threshold
        
        elif self.trigger_type == 'volume':
            volume_24h = self.get_24h_volume(self.token_address)
            return volume_24h >= self.threshold
        
        elif self.trigger_type == 'liquidity':
            liquidity = self.get_pool_liquidity(self.token_address)
            return liquidity >= self.threshold
        
        elif self.trigger_type == 'gas':
            gas_price = self.w3.eth.gas_price
            return gas_price <= self.w3.to_wei(self.threshold, 'gwei')`;
      }
      
      if (node.type === 'risk') {
        return `# Risk Management Check
from web3 import Web3
from decimal import Decimal

class RiskManager:
    def __init__(self):
        self.max_slippage = ${node.maxSlippage || 0.5}  # %
        self.max_gas_cost = ${node.maxGasCost || 0.05}  # ETH
        self.min_profit_margin = ${node.minProfitMargin || 1.0}  # %
    
    def validate_trade(self, trade_params):
        """Validate trade before execution"""
        # Check slippage
        estimated_slippage = self.estimate_slippage(trade_params)
        if estimated_slippage > self.max_slippage:
            return False, f"Slippage too high: {estimated_slippage}%"
        
        # Check gas cost
        estimated_gas = self.estimate_gas_cost(trade_params)
        if estimated_gas > self.max_gas_cost:
            return False, f"Gas cost too high: {estimated_gas} ETH"
        
        # Check profit margin
        estimated_profit = self.estimate_profit(trade_params)
        profit_margin = (estimated_profit / trade_params['amount']) * 100
        if profit_margin < self.min_profit_margin:
            return False, f"Profit margin too low: {profit_margin}%"
        
        return True, "Trade validated"`;
      }
      
      return `// ${node.type} node\n// Configure attributes in Properties tab`;
    },
    
    showCodeExample(type) {
      const examples = {
        arbitrage: `# Complete Arbitrage Bot Example
from web3 import Web3
from decimal import Decimal
import time

w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))

def check_arbitrage():
    # Get prices from Uniswap and SushiSwap
    uniswap_price = get_uniswap_price('ETH/USDC')
    sushi_price = get_sushiswap_price('ETH/USDC')
    
    profit_pct = abs(uniswap_price - sushi_price) / min(uniswap_price, sushi_price) * 100
    
    if profit_pct >= 0.5:  # Min 0.5% profit
        execute_arbitrage(uniswap_price, sushi_price)

def execute_arbitrage(price_a, price_b):
    if price_a < price_b:
        # Buy on Uniswap, sell on SushiSwap
        buy_tx = swap_on_uniswap('buy', amount)
        sell_tx = swap_on_sushiswap('sell', amount)
        return buy_tx and sell_tx
    return False

while True:
    check_arbitrage()
    time.sleep(1)`,
        liquidity: `# Uniswap V3 Liquidity Provider
from web3 import Web3
from uniswap import Uniswap

w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
uniswap = Uniswap(address, private_key, version=3)

def add_liquidity():
    # Add 1 ETH and 3000 USDC to pool
    pool_address = '0x...'  # ETH/USDC pool
    tick_lower = price_to_tick(1800)  # Lower price bound
    tick_upper = price_to_tick(2200)  # Upper price bound
    
    tx = uniswap.add_liquidity(
        token0='ETH',
        token1='USDC',
        amount0=1.0,
        amount1=3000.0,
        tick_lower=tick_lower,
        tick_upper=tick_upper,
        fee=3000  # 0.3% fee tier
    )
    return tx`,
        yield: `# Yield Farming Bot
from web3 import Web3
from aave import Aave

w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
aave = Aave(w3)

def farm_yield():
    # Check APY across protocols
    aave_apy = aave.get_supply_apy('USDC')
    compound_apy = compound.get_supply_apy('USDC')
    
    if aave_apy >= 5.0:  # Min 5% APY
        # Deposit 10,000 USDC
        tx = aave.supply('USDC', 10000)
        return tx
    
    return None`,
        mev: `# MEV Front-running Bot
from web3 import Web3
from flashbots import FlashbotsProvider

w3 = Web3(Web3.HTTPProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY'))
flashbots = FlashbotsProvider(w3)

def monitor_mempool():
    pending_txs = w3.eth.get_pending_transactions()
    
    for tx in pending_txs:
        profit = estimate_mev_profit(tx)
        
        if profit >= 0.01:  # Min 0.01 ETH profit
            # Build front-running transaction
            frontrun_tx = build_frontrun_tx(tx)
            flashbots.send_bundle([frontrun_tx, tx])
            break`
      };
      
      this.generatedCode = examples[type] || '// Code example not found';
      this.activeTab = 'code';
    },
    
    copyCode() {
      navigator.clipboard.writeText(this.generatedCode);
      alert('Code copied to clipboard!');
    }
  };
}
</script>
{% endblock %}


