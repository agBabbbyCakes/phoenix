{% set labels = latency_series | map(attribute=0) | list %}
{% set values = latency_series | map(attribute=1) | list %}

<!-- Health Summary Chips (will be populated by JS) -->
<div id="overview"></div>

<!-- KPI Cards with Live Transitions -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div
    class="stat glass-card shadow-xl rounded-box border border-primary/30 hover:border-primary transition-all enhanced-card p-0">
    <div class="stat-title px-4 pt-4">
      <span class="tooltip-definition" data-definition="Average response time for bot operations">Avg Latency</span>
    </div>
    <div class="stat-value px-4" 
         data-status="{{ 'error' if kpis.avg_latency_ms > 300 else 'warning' if kpis.avg_latency_ms > 200 else 'ok' }}"
         id="kpi-latency-value">{{ kpis.avg_latency_ms }}ms</div>
    <div class="stat-desc px-4 pb-4">Last 60s</div>
  </div>
  <div
    class="stat glass-card shadow-xl rounded-box border border-secondary/30 hover:border-secondary transition-all enhanced-card p-0">
    <div class="stat-title px-4 pt-4">
      <span class="tooltip-definition" data-definition="Percentage of successful operations">Success Rate</span>
    </div>
    <div class="stat-value px-4" 
         data-status="{{ 'error' if kpis.success_rate_pct < 80 else 'warning' if kpis.success_rate_pct < 90 else 'ok' }}"
         id="kpi-success-value">{{ kpis.success_rate_pct }}%</div>
    <div class="stat-desc px-4 pb-4">Last 60s</div>
  </div>
  <div
    class="stat glass-card shadow-xl rounded-box border border-accent/30 hover:border-accent transition-all enhanced-card p-0">
    <div class="stat-title px-4 pt-4">
      <span class="tooltip-definition" data-definition="Number of events processed per minute">Throughput</span>
    </div>
    <div class="stat-value px-4" id="kpi-throughput-value">{{ kpis.throughput_1m }}/min</div>
    <div class="stat-desc px-4 pb-4">Events</div>
  </div>
</div>

<!-- View Selector -->
<div id="charts" class="flex items-center justify-between mt-4 px-0">
  <h2 class="text-lg font-semibold">Live Charts</h2>
  <select id="viewSelector"
    class="select select-bordered bg-base-100 hover-glow">
    <option value="latency">Latency</option>
    <option value="throughput">Throughput</option>
    <option value="profit">Cumulative Profit</option>
    <option value="heatmap">Latency Heatmap</option>
    <option value="graph3d">3D Bot Network</option>
    <option value="financial3d">3D Financial Chart</option>
    <option value="pointcloud">3D Point Cloud</option>
    <option value="sensors">Sensors (Temp/Humidity)</option>
  </select>
</div>

<!-- Chart Containers - Full Width -->
<div class="w-full mt-2">
  <div class="card bg-base-100 shadow glass-card w-full"
    data-latency-labels='{{ labels | tojson }}'
    data-latency-values='{{ values | tojson }}'
    data-throughput-labels='{{ throughput_series | map(attribute=0) | list | tojson }}'
    data-throughput-values='{{ throughput_series | map(attribute=1) | list | tojson }}'
    data-profit-labels='{{ profit_series | map(attribute=0) | list | tojson }}'
    data-profit-values='{{ profit_series | map(attribute=1) | list | tojson }}'
    data-heat-cells='{{ heatmap.cells | tojson }}'
    data-heat-cols='{{ heatmap.cols }}'
    data-sensor-labels='[]'
    data-sensor-temp-values='[]'
    data-sensor-humidity-values='[]'>
    <div class="card-body p-0 w-full">
      <!-- Chart toolbar -->
      <div class="flex flex-wrap items-center gap-2 p-2" id="chartToolbar">
        <button class="btn btn-xs" id="btnResetZoom"
          title="Reset zoom (Z)">Reset Zoom</button>
        <label class="label cursor-pointer gap-2">
          <span class="label-text">Moving Avg</span>
          <input type="checkbox" id="toggleMA"
            class="toggle toggle-primary toggle-xs" />
        </label>
        <div class="divider divider-horizontal"></div>
        <label class="label cursor-pointer gap-2">
          <span class="label-text">Alert if latency ‚â•</span>
          <input id="alertLatency" type="number"
            class="input input-xs input-bordered w-24" placeholder="ms"
            min="1" />
        </label>
        <button class="btn btn-xs" id="btnSavePrefs">Save</button>
      </div>
      <div class="w-full" style="height: 400px; min-height: 400px;">
        <canvas id="chartPrimary" class="w-full h-full"></canvas>
        <canvas id="chartSecondary" class="w-full h-full" style="display: none;"></canvas>
        <canvas id="graph3dCanvas" class="w-full h-full" style="display: none;"></canvas>
        <canvas id="financial3dCanvas" class="w-full h-full" style="display: none;"></canvas>
        <div id="pointcloudContainer" style="display: none; width: 100%; height: 100%; position: relative;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bot Health (Full Width) -->
<div id="health" class="card bg-base-100 shadow mt-4 glass-event-table card-premium table-compact-premium w-full">
  <div class="card-body p-0 w-full">
    <div class="flex justify-between items-center mb-2 p-4 pb-2">
      <h2 class="card-title">Bot Health</h2>
      <div class="text-sm text-gray-500">Auto-refresh 5s</div>
    </div>
    <div class="flex items-center gap-3 mb-2 px-4">
      <div class="stat-chip text-emerald-300">OK</div>
      <div class="stat-chip text-yellow-300">Slow</div>
      <div class="stat-chip text-red-300">Errors</div>
      <div class="ml-2" style="--ok:60;--slow:25;--err:15">
        {% include 'components/css_status_ring.html' %}
      </div>
    </div>
    <div class="divider-lux mx-4"></div>
    <div id="bot-health-table-container"
         data-bot-health-table
         data-refresh-interval="5000"
         data-api-endpoint="/api/bots/status"
         class="px-4 pb-4 w-full">
      <!-- Compact BotHealthTable renders here -->
    </div>
  </div>
</div>

<!-- Recent Events Table with Enhanced Interactions - Full Width -->
<div id="events" class="card bg-base-100 shadow mt-4 glass-event-table enhanced-card card-premium table-compact-premium w-full">
  <div class="card-body p-0 w-full">
    <div class="flex justify-between items-center p-4 pb-2">
      <h2 class="card-title">Recent Events</h2>
      <div class="flex gap-2">
        <button class="btn btn-sm btn-ghost" onclick="window.dashboardUI.showCommandPalette()" title="Command Palette (‚åòK)">
          ‚åòK
        </button>
        <a href="/home" class="btn btn-sm btn-ghost">üè† Home</a>
        <a href="/logs" class="btn btn-sm btn-outline">üìã View All Logs</a>
      </div>
    </div>
    <div class="overflow-x-auto max-h-80 overflow-y-auto neon-scroll px-4 pb-4 w-full">
      <table class="table table-compact w-full" id="recent-events-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Bot</th>
            <th>Block</th>
            <th>Latency</th>
            <th>Status</th>
            <th>Tx</th>
          </tr>
        </thead>
        <tbody>
          {% for e in last_events %}
          <tr data-bot-name="{{ e.bot_name }}" 
              data-timestamp="{{ e.timestamp.isoformat() }}"
              onclick="window.dashboardUIHighlightRow(this)">
            <td class="code-data">{{ e.timestamp.strftime('%H:%M:%S') }}</td>
            <td>
              <span class="font-semibold">{{ e.bot_name }}</span>
            </td>
            <td class="code-data">-</td>
            <td class="code-data" 
                data-status="{{ 'error' if e.latency_ms > 300 else 'warning' if e.latency_ms > 200 else 'ok' }}">
              {{ e.latency_ms }}ms
            </td>
            <td>
              {% if e.error %}
              <span class="badge"
                style="background-color:hsl(var(--er)); color:hsl(var(--erc));"
                title="{{ e.error }}">Error</span>
              {% else %}
              <span class="badge badge-success">OK</span>
              {% endif %}
            </td>
            <td>
              {% if e.tx_hash %}
              <a class="link link-primary code-data" target="_blank"
                rel="noopener"
                href="https://etherscan.io/tx/{{ e.tx_hash }}"
                title="View on Etherscan">{{ e.tx_hash }}</a>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- charts are initialized in static/js/main.js after HTMX swaps -->
