{% set labels = latency_series | map(attribute=0) | list %}
{% set values = latency_series | map(attribute=1) | list %}

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div
        class="stat bg-base-100 shadow rounded-box border border-primary/30 hover:border-primary transition">
        <div class="stat-title">Avg Latency</div>
        <div class="stat-value">{{ kpis.avg_latency_ms }}ms</div>
        <div class="stat-desc">Last 60s</div>
    </div>
    <div
        class="stat bg-base-100 shadow rounded-box border border-secondary/30 hover:border-secondary transition">
        <div class="stat-title">Success Rate</div>
        <div class="stat-value">{{ kpis.success_rate_pct }}%</div>
        <div class="stat-desc">Last 60s</div>
    </div>
    <div
        class="stat bg-base-100 shadow rounded-box border border-accent/30 hover:border-accent transition">
        <div class="stat-title">Throughput</div>
        <div class="stat-value">{{ kpis.throughput_1m }}/min</div>
        <div class="stat-desc">Events</div>
    </div>
</div>

<!-- Latency Chart -->
<div class="card bg-base-100 shadow mt-4"
    data-latency-labels='{{ labels | tojson }}'
    data-latency-values='{{ values | tojson }}'>
    <div class="card-body">
        <h2 class="card-title">Latency</h2>
        <div class="h-64">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Events Table -->
<div class="card bg-base-100 shadow mt-4">
    <div class="card-body">
        <h2 class="card-title">Recent Events</h2>
        <div class="overflow-x-auto">
            <table class="table table-compact">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Bot</th>
                        <th>Block</th>
                        <th>Latency</th>
                        <th>Status</th>
                        <th>Tx</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in last_events %}
                    <tr>
                        <td>{{ e.timestamp.strftime('%H:%M:%S') }}</td>
                        <td>{{ e.bot_name }}</td>
                        <td>-</td>
                        <td>{{ e.latency_ms }}ms</td>
                        <td>
                            {% if e.error %}
                            <span class="badge"
                                style="background-color:hsl(var(--er)); color:hsl(var(--erc));"
                                title="{{ e.error }}">Error</span>
                            {% else %}
                            <span class="badge badge-success">OK</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if e.tx_hash %}
                            <a class="link link-primary" target="_blank"
                                rel="noopener"
                                href="https://etherscan.io/tx/{{ e.tx_hash }}">{{
                                e.tx_hash }}</a>
                            {% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
(function(){
  const card = document.currentScript.closest('.card');
  const labels = JSON.parse(card.dataset.latencyLabels || '[]');
  const values = JSON.parse(card.dataset.latencyValues || '[]');
  const ctx = document.getElementById('latencyChart');
  if (!window.__latencyChart) {
    window.__latencyChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Latency (ms)', data: values, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.2)', borderWidth: 2, tension: 0.25, pointRadius: 2 }] },
      options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  } else {
    const c = window.__latencyChart;
    c.data.labels = labels;
    c.data.datasets[0].data = values;
    c.update('none');
  }
})();
</script>
