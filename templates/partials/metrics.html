{% set labels = latency_series | map(attribute=0) | list %}
{% set values = latency_series | map(attribute=1) | list %}

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div
    class="stat glass-card shadow-xl rounded-box border border-primary/30 hover:border-primary transition-all">
    <div class="stat-title">Avg Latency</div>
    <div class="stat-value">{{ kpis.avg_latency_ms }}ms</div>
    <div class="stat-desc">Last 60s</div>
  </div>
  <div
    class="stat glass-card shadow-xl rounded-box border border-secondary/30 hover:border-secondary transition-all">
    <div class="stat-title">Success Rate</div>
    <div class="stat-value">{{ kpis.success_rate_pct }}%</div>
    <div class="stat-desc">Last 60s</div>
  </div>
  <div
    class="stat glass-card shadow-xl rounded-box border border-accent/30 hover:border-accent transition-all">
    <div class="stat-title">Throughput</div>
    <div class="stat-value">{{ kpis.throughput_1m }}/min</div>
    <div class="stat-desc">Events</div>
  </div>
</div>

<!-- View Selector -->
<div class="flex items-center justify-between mt-4">
  <h2 class="text-lg font-semibold">Live Charts</h2>
  <select id="viewSelector"
    class="select select-bordered bg-base-100 hover-glow">
    <option value="latency">Latency</option>
    <option value="throughput">Throughput</option>
    <option value="profit">Cumulative Profit</option>
    <option value="heatmap">Latency Heatmap</option>
    <option value="graph3d">3D Bot Network</option>
    <option value="sensors">Sensors (Temp/Humidity)</option>
  </select>
</div>

<!-- Chart Containers -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-2">
  <div class="card bg-base-100 shadow glass-card p-2"
    data-latency-labels='{{ labels | tojson }}'
    data-latency-values='{{ values | tojson }}'
    data-throughput-labels='{{ throughput_series | map(attribute=0) | list | tojson }}'
    data-throughput-values='{{ throughput_series | map(attribute=1) | list | tojson }}'
    data-profit-labels='{{ profit_series | map(attribute=0) | list | tojson }}'
    data-profit-values='{{ profit_series | map(attribute=1) | list | tojson }}'
    data-heat-cells='{{ heatmap.cells | tojson }}'
    data-heat-cols='{{ heatmap.cols }}'
    data-sensor-labels='[]'
    data-sensor-temp-values='[]'
    data-sensor-humidity-values='[]'>
    <div class="card-body">
      <!-- Chart toolbar -->
      <div class="flex flex-wrap items-center gap-2 mb-2" id="chartToolbar">
        <button class="btn btn-xs" id="btnResetZoom"
          title="Reset zoom (Z)">Reset Zoom</button>
        <label class="label cursor-pointer gap-2">
          <span class="label-text">Moving Avg</span>
          <input type="checkbox" id="toggleMA"
            class="toggle toggle-primary toggle-xs" />
        </label>
        <div class="divider divider-horizontal"></div>
        <label class="label cursor-pointer gap-2">
          <span class="label-text">Alert if latency ‚â•</span>
          <input id="alertLatency" type="number"
            class="input input-xs input-bordered w-24" placeholder="ms"
            min="1" />
        </label>
        <button class="btn btn-xs" id="btnSavePrefs">Save</button>
      </div>
      <div class="h-48 min-h-32">
        <canvas id="chartPrimary"></canvas>
      </div>
    </div>
  </div>
  <div class="card bg-base-100 shadow glass-card p-2">
    <div class="card-body">
      <div class="h-48 min-h-32">
        <canvas id="chartSecondary"></canvas>
        <canvas id="graph3dCanvas" style="display: none;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Recent Events Table -->
<div class="card bg-base-100 shadow mt-4 glass-event-table">
  <div class="card-body">
    <div class="flex justify-between items-center">
      <h2 class="card-title">Recent Events</h2>
      <div class="flex gap-2">
        <a href="/home" class="btn btn-sm btn-ghost">üè† Home</a>
        <a href="/logs" class="btn btn-sm btn-outline">üìã View All Logs</a>
      </div>
    </div>
    <div class="overflow-x-auto max-h-80 overflow-y-auto neon-scroll">
      <table class="table table-compact">
        <thead>
          <tr>
            <th>Time</th>
            <th>Bot</th>
            <th>Block</th>
            <th>Latency</th>
            <th>Status</th>
            <th>Tx</th>
          </tr>
        </thead>
        <tbody>
          {% for e in last_events %}
          <tr>
            <td>{{ e.timestamp.strftime('%H:%M:%S') }}</td>
            <td>{{ e.bot_name }}</td>
            <td>-</td>
            <td>{{ e.latency_ms }}ms</td>
            <td>
              {% if e.error %}
              <span class="badge"
                style="background-color:hsl(var(--er)); color:hsl(var(--erc));"
                title="{{ e.error }}">Error</span>
              {% else %}
              <span class="badge badge-success">OK</span>
              {% endif %}
            </td>
            <td>
              {% if e.tx_hash %}
              <a class="link link-primary" target="_blank"
                rel="noopener"
                href="https://etherscan.io/tx/{{ e.tx_hash }}">{{
                e.tx_hash }}</a>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- charts are initialized in static/js/main.js after HTMX swaps -->
